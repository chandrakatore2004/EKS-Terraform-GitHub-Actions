name: Terraform

on:
  workflow_dispatch:
    inputs:
      tfvars_file:
        description: "Path to the .tfvars file"
        required: true
        default: "dev.tfvars"
      action:
        type: choice
        description: "Plan / Apply / Destroy"
        options:
          - plan
          - apply
          - destroy
        required: true
        default: "apply"

env:
  TERRAFORM_CLI_PATH: ""        # Prevent Linux runner bug
  AWS_REGION: ap-south-1
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

permissions:
  contents: write

jobs:
  terraform:
    name: Terraform Pipeline
    runs-on: self-hosted

    defaults:
      run:
        shell: bash
        working-directory: eks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install prerequisites & Terraform
        run: |
          set -euo pipefail
          TF_VERSION="1.12.1"
          ARCH="linux_amd64"

          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y curl unzip ca-certificates
          elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y curl unzip
          fi

          TMP=$(mktemp -d)
          curl -fsSL "https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_${ARCH}.zip" -o "$TMP/tf.zip"
          unzip -q "$TMP/tf.zip" -d "$TMP"
          sudo mv "$TMP/terraform" /usr/local/bin/terraform
          sudo chmod +x /usr/local/bin/terraform
          rm -rf "$TMP"

      - name: Debug Terraform binary
        run: |
          which terraform || true
          terraform -v || true

      - name: Terraform Init (clean)
        run: |
          rm -rf .terraform terraform.tfstate* || true
          terraform init -input=false

      - name: Terraform Format (safe & auto-commit)
        run: |
          set -euo pipefail

          # Run formatting
          terraform fmt -recursive

          # Ensure .terraform and providers never get committed
          echo "*.tfstate"           >> ../../.gitignore
          echo "*.tfstate.backup"    >> ../../.gitignore
          echo ".terraform/"         >> ../../.gitignore
          echo ".terraform.lock.hcl" >> ../../.gitignore

          git add -u
          git add '*.tf' '*.tfvars' || true

          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Formatting changed files. Committing..."
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git commit -m "chore: format Terraform files (auto)"
            git push origin HEAD:"${GITHUB_REF#refs/heads/}"
          else
            echo "No formatting changes."
          fi

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        if: ${{ github.event.inputs.action == 'plan' }}
        run: terraform plan -var-file="${{ github.event.inputs.tfvars_file }}" -input=false

      - name: Terraform Apply
        if: ${{ github.event.inputs.action == 'apply' }}
        run: terraform apply -auto-approve -var-file="${{ github.event.inputs.tfvars_file }}" -input=false

      - name: Terraform Destroy
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: terraform destroy -auto-approve -var-file="${{ github.event.inputs.tfvars_file }}" -input=false

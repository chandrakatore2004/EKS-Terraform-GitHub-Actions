name: Terraform

on:
  workflow_dispatch:
    inputs:
      tfvars_file:
        description: 'Path to the .tfvars file'
        required: true
        default: 'dev.tfvars'
      action:
        type: choice
        description: 'Plan / Apply / Destroy'
        options:
          - plan
          - apply
          - destroy
        required: true
        default: 'apply'

# Top-level override to ensure the broken value is not inherited
env:
  TERRAFORM_CLI_PATH: ""                # <<-- clear broken runner env here
  AWS_REGION: ap-south-1
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

permissions:
  contents: read

jobs:
  terraform:
    name: Terraform pipeline
    runs-on: qa

    defaults:
      run:
        shell: bash
        working-directory: eks

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # also clear on the step level (extra safety)
        env:
          TERRAFORM_CLI_PATH: ""

      - name: Setup Terraform (install)
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.12.1
        env:
          TERRAFORM_CLI_PATH: ""

      - name: "Debug: show terraform and env (safe)"
        env:
          TERRAFORM_CLI_PATH: ""
        run: |
          echo "----- which terraform -----"
          which terraform || echo "terraform not found"
          terraform -v || echo "terraform -v failed"
          echo "----- TERRAFORM_CLI_PATH (before) -----"
          echo "$TERRAFORM_CLI_PATH"
          # unset problematic var if set (extra safety)
          unset TERRAFORM_CLI_PATH || true
          echo "----- TERRAFORM_CLI_PATH (after unset) -----"
          echo "$TERRAFORM_CLI_PATH"

      - name: Terraform Init (clean and init)
        env:
          TERRAFORM_CLI_PATH: ""
        run: |
          rm -rf .terraform terraform.tfstate* || true
          terraform init -input=false

      - name: Terraform Format
        env:
          TERRAFORM_CLI_PATH: ""
        run: terraform fmt -check

      - name: Terraform Validate
        env:
          TERRAFORM_CLI_PATH: ""
        run: terraform validate

      - name: Terraform Plan
        if: ${{ github.event.inputs.action == 'plan' }}
        env:
          TERRAFORM_CLI_PATH: ""
        run: terraform plan -var-file="${{ github.event.inputs.tfvars_file }}" -input=false

      - name: Terraform Apply
        if: ${{ github.event.inputs.action == 'apply' }}
        env:
          TERRAFORM_CLI_PATH: ""
        run: terraform apply -auto-approve -var-file="${{ github.event.inputs.tfvars_file }}" -input=false

      - name: Terraform Destroy
        if: ${{ github.event.inputs.action == 'destroy' }}
        env:
          TERRAFORM_CLI_PATH: ""
        run: terraform destroy -auto-approve -var-file="${{ github.event.inputs.tfvars_file }}" -input=false

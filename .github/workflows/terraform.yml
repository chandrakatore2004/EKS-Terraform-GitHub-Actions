name: Terraform

on:
  workflow_dispatch:
    inputs:
      tfvars_file:
        description: 'Path to the .tfvars file'
        required: true
        default: 'dev.tfvars'
      action:
        type: choice
        description: 'Plan / Apply / Destroy'
        options:
          - plan
          - apply
          - destroy
        required: true
        default: 'apply'

# Top-level override to ensure the broken value is not inherited
env:
  TERRAFORM_CLI_PATH: ""                # <<-- clear broken runner env here
  AWS_REGION: ap-south-1
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

permissions:
  contents: read

jobs:
  terraform:
    name: Terraform pipeline
    runs-on: qa

    defaults:
      run:
        shell: bash
        working-directory: eks

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        env:
          TERRAFORM_CLI_PATH: ""

      - name: Install prerequisites and Terraform (runner)
        # Installs node (if missing), curl, unzip, and Terraform binary
        env:
          TERRAFORM_CLI_PATH: ""
        run: |
          set -euo pipefail
          TF_VERSION="${TF_VERSION:-1.12.1}"  # change if you need a different version
          ARCH="linux_amd64"

          echo "Detecting package manager..."
          if command -v apt-get >/dev/null 2>&1; then
            PM="apt"
            sudo apt-get update -y
            sudo apt-get install -y curl unzip gnupg ca-certificates
            # install node if missing
            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
          elif command -v yum >/dev/null 2>&1 || command -v dnf >/dev/null 2>&1; then
            PM="yum"
            sudo yum install -y curl unzip
            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
              sudo yum install -y nodejs
            fi
          elif command -v apk >/dev/null 2>&1; then
            PM="apk"
            sudo apk add --no-cache curl unzip nodejs npm
          else
            echo "Unsupported package manager. Please ensure curl/unzip/node are installed on the runner."
          fi

          echo "Installing Terraform ${TF_VERSION}..."
          TMPDIR=$(mktemp -d)
          trap 'rm -rf "$TMPDIR"' EXIT
          TF_ARCHIVE="${TMPDIR}/terraform.zip"
          TF_URL="https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_${ARCH}.zip"
          echo "Downloading ${TF_URL} ..."
          curl -fsSL "$TF_URL" -o "$TF_ARCHIVE"
          unzip -q "$TF_ARCHIVE" -d "$TMPDIR"
          sudo mv "$TMPDIR/terraform" /usr/local/bin/terraform
          sudo chmod +x /usr/local/bin/terraform

          echo "Verify installations:"
          node -v || true
          which terraform || true
          terraform -v || true

      - name: "Debug: show terraform and env (safe)"
        env:
          TERRAFORM_CLI_PATH: ""
        run: |
          echo "----- which terraform -----"
          which terraform || echo "terraform not found"
          terraform -v || echo "terraform -v failed"
          echo "----- TERRAFORM_CLI_PATH (before) -----"
          echo "$TERRAFORM_CLI_PATH"
          # unset problematic var if set (extra safety)
          unset TERRAFORM_CLI_PATH || true
          echo "----- TERRAFORM_CLI_PATH (after unset) -----"
          echo "$TERRAFORM_CLI_PATH"

      - name: Terraform Init (clean and init)
        env:
          TERRAFORM_CLI_PATH: ""
        run: |
          rm -rf .terraform terraform.tfstate* || true
          terraform init -input=false

      - name: Terraform Format Check (recursive)
        env:
          TERRAFORM_CLI_PATH: ""
        run: terraform fmt -check -recursive

      - name: Terraform Validate
        env:
          TERRAFORM_CLI_PATH: ""
        run: terraform validate

      - name: Terraform Plan
        if: ${{ github.event.inputs.action == 'plan' }}
        env:
          TERRAFORM_CLI_PATH: ""
        run: terraform plan -var-file="${{ github.event.inputs.tfvars_file }}" -input=false

      - name: Terraform Apply
        if: ${{ github.event.inputs.action == 'apply' }}
        env:
          TERRAFORM_CLI_PATH: ""
        run: terraform apply -auto-approve -var-file="${{ github.event.inputs.tfvars_file }}" -input=false

      - name: Terraform Destroy
        if: ${{ github.event.inputs.action == 'destroy' }}
        env:
          TERRAFORM_CLI_PATH: ""
        run: terraform destroy -auto-approve -var-file="${{ github.event.inputs.tfvars_file }}" -input=false
